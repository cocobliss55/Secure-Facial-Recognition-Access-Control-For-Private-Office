{% extends "base.html" %}

{% block title %}Add Employee - Facial Recognition Access Control{% endblock %}

{% block extra_css %}
<style>
    /* Fix for unwanted bars */
    body::before, body::after,
    .video-container::before, .video-container::after,
    .add-employee-container::before, .add-employee-container::after,
    div[style*="position: fixed"],
    div[style*="width: 100%"],
    .capture-message[style*="position: absolute"] {
        display: none !important;
        content: none !important;
        height: 0 !important;
        background: transparent !important;
        border: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* Override for capture message if it's positioned as a bar */
    #capture-message {
        position: static !important;
        width: auto !important;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        text-align: left !important;
        font-size: 14px !important;
        padding: 0 !important;
        margin-bottom: 10px !important;
    }
    
    /* General styling */
    .add-employee-container {
        max-width: 80%;
        margin: 0 auto;
        padding: 0 15px;
    }
    
    .add-employee-header {
        margin-bottom: 20px;
        text-align: center;
    }
    
    .add-employee-header h2 {
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    /* Main layout improvements */
    .flex-container {
        display: flex;
        flex-direction: row;
        margin-bottom: 20px;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .video-section {
        flex: 3;
        min-width: 400px;
    }
    
    .form-section {
        flex: 2;
        min-width: 320px;
    }
    
    /* Camera and preview layout */
    .camera-preview-container {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }
    
    .camera-container {
        flex: 3;
        min-width: 320px;
    }
    
    .side-preview-container {
        flex: 1;
        min-width: 160px;
        width: 200px;
        display: flex;
        flex-direction: column;
        align-self: flex-start;
        padding: 10px;
        background-color: #f8f8f8;
        border-radius: 5px;
        border: 1px solid #ddd;
        gap: 15px;
    }
    
    .side-preview-group {
        margin-bottom: 5px;
    }
    
    .side-preview-group .side-preview-title {
        font-size: 11px;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        text-align: center;
        padding: 2px 5px;
        background-color: #e2e2e2;
        border-radius: 3px;
    }
    
    /* Larger video container */
    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 75%; /* 4:3 aspect ratio */
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Face detection overlay */
    .face-detection-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 15;
    }
    
    .face-detection-box {
        position: absolute;
        border: 3px solid #2ecc71;
        border-radius: 4px;
        display: none;  /* Always hide the detection box */
        box-sizing: border-box;
        pointer-events: none;
    }
    
    /* Face detection text */
    .face-detection-text {
        position: absolute;
        top: 15px;
        left: 15px;
        background-color: rgba(46, 204, 113, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        z-index: 20;
        display: block;
    }
    
    .brightness-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .spacebar-hint {
        position: absolute;
        bottom: 40px;
        left: 0;
        right: 0;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 5px 10px;
        font-size: 12px;
        z-index: 11;
        display: block;
    }
    
    /* Face guide and indicators */
    .face-guide {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 180px;
        height: 220px;
        border: 3px dashed rgba(255, 255, 255, 0.5);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        pointer-events: none;
        z-index: 10;
    }
    
    .face-guide::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 40%;
        width: 80%;
        height: 1px;
        background-color: rgba(255, 255, 255, 0.4);
        transform: translateX(-50%);
    }
    
    .face-guide::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        height: 100%;
        width: 1px;
        background-color: rgba(255, 255, 255, 0.4);
        transform: translateX(-50%);
    }
    
    .face-alignment-tip {
        position: absolute;
        bottom: 15px;
        left: 0;
        right: 0;
        text-align: center;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 5px 10px;
        font-size: 12px;
        z-index: 10;
        width: auto;
        border-radius: 0;
        box-shadow: none;
    }
    
    /* Improved capture controls */
    .capture-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .capture-message {
        font-size: 14px;
        color: #555;
        margin-bottom: 5px;
        padding: 5px;
    }
    
    .capture-message.success {
        font-size: 13px;
        color: #2ecc71;
        background-color: rgba(46, 204, 113, 0.1);
        padding: 4px 8px;
        border-radius: 3px;
        display: inline-block;
    }
    
    .capture-btn-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    /* Angle progress indicators */
    .capture-progress {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 5px;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .angle-step {
        text-align: center;
        padding: 8px 12px;
        background-color: #ddd;
        border-radius: 4px;
        flex: 1;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    
    .angle-step.active {
        background-color: #3498db;
        color: white;
        font-weight: bold;
    }
    
    .angle-step.completed {
        background-color: #2ecc71;
        color: white;
    }
    
    .angle-step .key-hint {
        font-size: 10px;
        background-color: rgba(255,255,255,0.3);
        padding: 2px 5px;
        border-radius: 3px;
    }
    
    /* Preview images */
    .side-preview {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .side-angle-container {
        position: relative;
        width: 100%;
        border: 2px solid transparent;
        border-radius: 5px;
    }
    
    .side-angle-container.active {
        border-color: #3498db;
    }
    
    .side-preview-image {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: block;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background-color: #eee;
        position: relative;
    }
    
    .side-preview-image.empty {
        background-image: none;
        background-color: #e0e0e0;
    }
    
    .side-preview-image.empty::before {
        content: none;
    }
    
    .side-angle-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        font-size: 10px;
        background-color: rgba(0,0,0,0.6);
        color: white;
        text-align: center;
        padding: 2px 0;
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
    }
    
    /* Information panels */
    .photo-quality-tips {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .angle-instructions {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #2e86de;
        font-size: 16px;
    }
    
    /* Keyboard shortcuts info */
    .keyboard-shortcuts {
        position: absolute;
        top: 15px;
        left: 15px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 5px;
        border-radius: 3px;
        font-size: 11px;
        z-index: 10;
    }
    
    /* Spectacles option */
    .spectacles-option {
        margin-top: 15px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        border-left: 4px solid #9b59b6;
    }
    
    .specs-option-label {
        font-size: 14px;
        color: white;
        font-weight: normal;
        font-family: inherit;
    }
    
    .specs-info {
        font-size: 12px;
        margin-top: 5px;
        color: #555;
    }
    
    #specs-status {
        font-weight: bold;
        margin-left: 5px;
    }
    
    /* Submit button */
    .submit-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }
    
    .submit-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    
    /* Form elements */
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    /* Hide the second group initially */
    .side-preview-group.without-glasses {
        display: none;
    }
    
    /* Show both groups when capturing with glasses */
    .capturing-both .side-preview-group.without-glasses {
        display: block;
    }
    
    /* In-video controls - new section */
    .in-video-controls {
        margin-top: 15px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    
    .capture-message-container {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        text-align: center;
        width: 100%;
    }
    
    .in-video-btn {
        background-color: #2ecc71;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
    }
    
    .in-video-btn:hover {
        background-color: #27ae60;
    }
    
    .specs-option-container {
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px 15px;
        border-radius: 5px;
        color: white;
        width: 100%;
    }
    
    .specs-option-container .specs-option-title {
        font-weight: bold;
        margin-bottom: 8px;
        text-align: center;
    }
    
    .specs-radio-group {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 5px;
    }
    
    .specs-radio-option {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .specs-status {
        margin-top: 5px;
        font-size: 12px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="add-employee-container">
    <div class="add-employee-header">
    <h2>Add New Employee</h2>
        <p>Capture 5 face angles for enhanced recognition accuracy</p>
    </div>
    
    <div class="flex-container">
        <!-- Video capture section -->
        <div class="video-section">
            <div class="angle-instructions" id="angle-instructions">
                <strong>Front Pose:</strong> Look directly at the camera with your face centered in the oval guide. Keep your head straight.
    </div>
    
    <div class="capture-progress">
                <div class="angle-step active" id="step-front">
                    Front
                    <span class="key-hint">F1</span>
                </div>
                <div class="angle-step" id="step-left">
                    Left
                    <span class="key-hint">F2</span>
                </div>
                <div class="angle-step" id="step-right">
                    Right
                    <span class="key-hint">F3</span>
                </div>
                <div class="angle-step" id="step-up">
                    Up
                    <span class="key-hint">F4</span>
                </div>
                <div class="angle-step" id="step-down">
                    Down
                    <span class="key-hint">F5</span>
    </div>
    </div>
    
            <div class="camera-preview-container">
                <div class="camera-container">
                    <div class="video-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div class="face-guide" id="faceGuide"></div>
                        <div class="brightness-indicator" id="brightnessIndicator">Checking lighting...</div>
                        <!-- Face detection overlay -->
                        <div class="face-detection-overlay" id="faceDetectionOverlay">
                            <div class="face-detection-box" id="faceDetectionBox"></div>
                            <div class="face-detection-text" id="faceDetectionText">Detecting face...</div>
                            <div class="spacebar-hint" id="spacebarHint">Face detected! Press SPACE to capture</div>
                        </div>
                    </div>
                </div>
                
                <div class="side-preview-container" id="preview-container">
                    <div class="side-preview-group with-glasses">
                        <div class="side-preview-title" id="with-glasses-title">Photos</div>
                        <div class="side-preview">
                            <div class="side-angle-container">
                                <img id="preview-front" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Front</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-left" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Left</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-right" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Right</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-up" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Up</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-down" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Down</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="side-preview-group without-glasses">
                        <div class="side-preview-title">Without Glasses</div>
                        <div class="side-preview">
                            <div class="side-angle-container">
                                <img id="preview-front-glasses" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Front</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-left-glasses" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Left</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-right-glasses" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Right</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-up-glasses" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Up</div>
                            </div>
                            <div class="side-angle-container">
                                <img id="preview-down-glasses" class="side-preview-image empty" alt="">
                                <div class="side-angle-label">Down</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Moved in-video controls here -->
            <div class="in-video-controls">
                <div class="capture-message-container">
                    <div id="capture-message">Position face for front angle capture</div>
                </div>
                
                <button type="button" id="captureButton" class="in-video-btn">Capture Front Angle</button>
                
                <div class="specs-option-container">
                    <div class="specs-option-title">Does the employee wear glasses/spectacles?</div>
                    <div class="specs-radio-group">
                        <div class="specs-radio-option">
                            <input type="radio" id="specs-yes" name="specs-mode" value="yes">
                            <label for="specs-yes" class="specs-option-label">Yes</label>
                        </div>
                        <div class="specs-radio-option">
                            <input type="radio" id="specs-no" name="specs-mode" value="no" checked>
                            <label for="specs-no" class="specs-option-label">No</label>
                        </div>
                    </div>
                    <div class="specs-status">
                        Current capture: <span id="specs-status">Without glasses</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Form section -->
        <div class="form-section">
            <div class="photo-quality-tips">
                <h4>For Best Recognition Quality:</h4>
                <ul>
                    <li>Ensure good, even lighting on the face</li>
                    <li>Position the face centered and straight in the oval guide</li>
                    <li>Keep a neutral expression or slight smile</li>
                    <li>For employees who wear glasses, consider capturing both with and without glasses</li>
                </ul>
    </div>
    
    <form id="addEmployeeForm" method="POST" action="{{ url_for('add_new_employee_with_face') }}">
        <div class="form-group">
            <label for="employee_id">Employee ID</label>
            <input type="text" id="employee_id" name="employee_id" required>
        </div>
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
                
                <!-- Hidden inputs for captured images -->
        <input type="hidden" id="captured_image_front" name="captured_image_front">
        <input type="hidden" id="captured_image_left" name="captured_image_left">
        <input type="hidden" id="captured_image_right" name="captured_image_right">
        <input type="hidden" id="captured_image_up" name="captured_image_up">
        <input type="hidden" id="captured_image_down" name="captured_image_down">
                
                <!-- Hidden inputs for glasses/spectacles variation -->
                <input type="hidden" id="captured_image_front_glasses" name="captured_image_front_glasses">
                <input type="hidden" id="captured_image_left_glasses" name="captured_image_left_glasses">
                <input type="hidden" id="captured_image_right_glasses" name="captured_image_right_glasses">
                <input type="hidden" id="captured_image_up_glasses" name="captured_image_up_glasses">
                <input type="hidden" id="captured_image_down_glasses" name="captured_image_down_glasses">
                
        <input type="hidden" id="specs_mode" name="specs_mode" value="without">
                
        <button type="submit" id="submitBtn" class="submit-btn" disabled>Add Employee</button>
    </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('captureButton');
    const submitBtn = document.getElementById('submitBtn');
    const captureMessage = document.getElementById('capture-message');
    const brightnessIndicator = document.getElementById('brightnessIndicator');
    const angleInstructions = document.getElementById('angle-instructions');
    const specsStatus = document.getElementById('specs-status');
    
    // Preview images
    const previewFront = document.getElementById('preview-front');
    const previewLeft = document.getElementById('preview-left');
    const previewRight = document.getElementById('preview-right');
    const previewUp = document.getElementById('preview-up');
    const previewDown = document.getElementById('preview-down');
    
    // Hidden inputs
    const capturedImageFront = document.getElementById('captured_image_front');
    const capturedImageLeft = document.getElementById('captured_image_left');
    const capturedImageRight = document.getElementById('captured_image_right');
    const capturedImageUp = document.getElementById('captured_image_up');
    const capturedImageDown = document.getElementById('captured_image_down');
    
    // Spectacles inputs
    const capturedImageFrontGlasses = document.getElementById('captured_image_front_glasses');
    const capturedImageLeftGlasses = document.getElementById('captured_image_left_glasses');
    const capturedImageRightGlasses = document.getElementById('captured_image_right_glasses');
    const capturedImageUpGlasses = document.getElementById('captured_image_up_glasses');
    const capturedImageDownGlasses = document.getElementById('captured_image_down_glasses');
    const specsMode = document.getElementById('specs_mode');
    
    // Spectacles radio buttons
    const specsYes = document.getElementById('specs-yes');
    const specsNo = document.getElementById('specs-no');
    
    // Step indicators
    const stepFront = document.getElementById('step-front');
    const stepLeft = document.getElementById('step-left');
    const stepRight = document.getElementById('step-right');
    const stepUp = document.getElementById('step-up');
    const stepDown = document.getElementById('step-down');
    
    // Capture state
    const angles = ['front', 'left', 'right', 'up', 'down'];
    let currentAngleIndex = 0;
    const capturedAngles = [];
    const withGlassesCaptured = [];
    const withoutGlassesCaptured = [];
    let needsGlassesCapture = false;
    let currentSpecsMode = 'without';
    
    // Face detection elements
    const faceDetectionBox = document.getElementById('faceDetectionBox');
    const faceDetectionText = document.getElementById('faceDetectionText');
    const spacebarHint = document.getElementById('spacebarHint');
    
    // Face detection state
    let isFaceDetected = false;
    let faceDetectionTimer = null;
    let lastFaceDetectionTime = 0;
    const FACE_DETECTION_INTERVAL = 100; // Faster refresh rate for better responsiveness
    
    // Instructions for each angle
    const angleInstructionsText = {
        'front': '<strong>Front Pose:</strong> Look directly at the camera with your face centered in the oval guide. Keep your head straight.',
        'left': '<strong>Left Pose:</strong> Turn your head to the left about 45 degrees while keeping your eyes on the camera.',
        'right': '<strong>Right Pose:</strong> Turn your head to the right about 45 degrees while keeping your eyes on the camera.',
        'up': '<strong>Up Pose:</strong> Tilt your chin up slightly while looking at the camera.',
        'down': '<strong>Down Pose:</strong> Tilt your chin down slightly while looking at the camera.'
    };
    
    // Function to calculate average brightness of video frame
    function calculateBrightness(imageData) {
        const data = imageData.data;
        let r, g, b, avg;
        let colorSum = 0;
        
        for(let x = 0, len = data.length; x < len; x += 4) {
            r = data[x];
            g = data[x+1];
            b = data[x+2];
            
            avg = Math.floor((r + g + b) / 3);
            colorSum += avg;
        }
        
        return Math.floor(colorSum / (imageData.width * imageData.height));
    }
    
    // Function to update the UI for the current angle
    function updateAngleUI() {
        const currentAngle = angles[currentAngleIndex];
        
        // Update instructions
        angleInstructions.innerHTML = angleInstructionsText[currentAngle];
        
        // Update capture button text
        captureButton.textContent = `Capture ${currentAngle.charAt(0).toUpperCase() + currentAngle.slice(1)} Angle`;
        
        // Update progress steps
        document.querySelectorAll('.angle-step').forEach(step => {
            step.classList.remove('active');
        });
        
        document.getElementById(`step-${currentAngle}`).classList.add('active');
        
        // Update capture message
        captureMessage.textContent = `Position face for ${currentAngle} angle capture`;
        
        // Highlight current angle in side preview based on current mode
        document.querySelectorAll('.side-angle-container').forEach(container => {
            container.classList.remove('active');
        });
        
        if (currentSpecsMode === 'with') {
            // Highlight in the first group
            const currentPreviewContainer = document.querySelector(`.with-glasses .side-angle-container:nth-child(${currentAngleIndex + 1})`);
            if (currentPreviewContainer) {
                currentPreviewContainer.classList.add('active');
            }
        } else {
            // Highlight in the second group if capturing both, otherwise in the first group
            const selector = needsGlassesCapture ? 
                `.without-glasses .side-angle-container:nth-child(${currentAngleIndex + 1})` : 
                `.with-glasses .side-angle-container:nth-child(${currentAngleIndex + 1})`;
                
            const currentPreviewContainer = document.querySelector(selector);
            if (currentPreviewContainer) {
                currentPreviewContainer.classList.add('active');
            }
        }
    }
    
    // Function to move to the next angle
    function moveToNextAngle() {
        // Mark current step as completed
        document.getElementById(`step-${angles[currentAngleIndex]}`).classList.add('completed');
        document.getElementById(`step-${angles[currentAngleIndex]}`).classList.remove('active');
        
        // Move to next angle
        currentAngleIndex++;
        
        // Check if we've completed all angles
        if (currentAngleIndex >= angles.length) {
            // If employee wears glasses and we've just finished 'with glasses'
            if (needsGlassesCapture && currentSpecsMode === 'with') {
                // Switch to 'without glasses' mode and restart
                currentSpecsMode = 'without';
                specsStatus.textContent = 'Without glasses';
                currentAngleIndex = 0;
                updateAngleUI();
                captureMessage.textContent = 'Remove glasses';
                return;
            }
            
            // Enable submit button
            submitBtn.disabled = false;
            captureButton.disabled = true;
            captureMessage.textContent = 'All angles captured, ready to add employee';
            captureMessage.className = 'capture-message success';
            return;
        }
        
        // Update UI for next angle
        updateAngleUI();
    }
    
    // Function to capture current angle
    function captureCurrentAngle() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw the current video frame on the canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Create a smaller canvas for compression
        const compressionCanvas = document.createElement('canvas');
        const compressionContext = compressionCanvas.getContext('2d');
        
        // Set to a smaller size - 400px max width/height while maintaining aspect ratio
        const MAX_SIZE = 400;
        let targetWidth = canvas.width;
        let targetHeight = canvas.height;
        
        if (canvas.width > MAX_SIZE || canvas.height > MAX_SIZE) {
            if (canvas.width > canvas.height) {
                targetWidth = MAX_SIZE;
                targetHeight = Math.round(canvas.height * (MAX_SIZE / canvas.width));
            } else {
                targetHeight = MAX_SIZE;
                targetWidth = Math.round(canvas.width * (MAX_SIZE / canvas.height));
            }
        }
        
        // Set compression canvas size
        compressionCanvas.width = targetWidth;
        compressionCanvas.height = targetHeight;
        
        // Draw resized image on compression canvas
        compressionContext.drawImage(canvas, 0, 0, canvas.width, canvas.height, 
                                    0, 0, targetWidth, targetHeight);
        
        // Convert with reduced quality (0.7 = 70% quality)
        const imageData = compressionCanvas.toDataURL('image/jpeg', 0.7);
        
        // Store in appropriate hidden input
        const currentAngle = angles[currentAngleIndex];
        
        let previewImage;
        
        if (currentSpecsMode === 'with') {
            // Store in regular inputs (with glasses)
            const capturedImageInput = document.getElementById(`captured_image_${currentAngle}`);
            capturedImageInput.value = imageData;
            
            // Show in with-glasses preview
            previewImage = document.getElementById(`preview-${currentAngle}`);
            
            // Add to captured angles with glasses
            if (!withGlassesCaptured.includes(currentAngle)) {
                withGlassesCaptured.push(currentAngle);
            }
        } else {
            // If employee wears glasses, store in glasses variation inputs
            if (needsGlassesCapture) {
                const capturedImageInput = document.getElementById(`captured_image_${currentAngle}_glasses`);
                capturedImageInput.value = imageData;
                
                // Show in without-glasses preview
                previewImage = document.getElementById(`preview-${currentAngle}-glasses`);
            } else {
                // Otherwise store in regular inputs
                const capturedImageInput = document.getElementById(`captured_image_${currentAngle}`);
                capturedImageInput.value = imageData;
                
                // Show in regular preview
                previewImage = document.getElementById(`preview-${currentAngle}`);
            }
            
            // Add to captured angles without glasses
            if (!withoutGlassesCaptured.includes(currentAngle)) {
                withoutGlassesCaptured.push(currentAngle);
            }
        }
        
        // Show preview image
        previewImage.src = imageData;
        previewImage.classList.remove('empty');
        
        // Add to general captured angles for form validation
        if (!capturedAngles.includes(currentAngle)) {
            capturedAngles.push(currentAngle);
        }
        
        // Update specs mode in hidden input
        if (needsGlassesCapture) {
            specsMode.value = 'both';
        } else {
            specsMode.value = 'without';
        }
        
        // Move to next angle
        moveToNextAngle();
    }
    
    // Direct capture of specific angle
    function captureSpecificAngle(angleIndex) {
        if (angleIndex < 0 || angleIndex >= angles.length) return;
        
        // Save current index to return to after capture
        const previousIndex = currentAngleIndex;
        
        // Set current angle to target
        currentAngleIndex = angleIndex;
        
        // Perform capture
        captureCurrentAngle();
        
        // Return to previous angle if it wasn't completed
        if (previousIndex !== angleIndex && previousIndex < angles.length) {
            currentAngleIndex = previousIndex;
            updateAngleUI();
        }
    }
    
    // Start the camera when page loads
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                } 
            });
            
            video.srcObject = stream;
            updateAngleUI();
            
            // Monitor video brightness
            setInterval(() => {
                if (!video.videoWidth) return; // Skip if video not loaded
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get brightness
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const brightness = calculateBrightness(imageData);
                
                // Update brightness indicator
                if (brightness < 50) {
                    brightnessIndicator.textContent = "Bad Lighting";
                    brightnessIndicator.style.backgroundColor = "rgba(231, 76, 60, 0.7)";
                } else if (brightness > 200) {
                    brightnessIndicator.textContent = "Bad Lighting";
                    brightnessIndicator.style.backgroundColor = "rgba(230, 126, 34, 0.7)";
                } else {
                    brightnessIndicator.textContent = "Good Lighting";
                    brightnessIndicator.style.backgroundColor = "rgba(46, 204, 113, 0.7)";
                }
            }, 1000);
            
        } catch (err) {
            console.error('Error accessing camera:', err);
            captureMessage.textContent = 'Error accessing camera. Please check permissions.';
        }
    });
    
    // Capture button handler
    captureButton.addEventListener('click', () => {
        captureCurrentAngle();
    });
    
    // Spectacles option handlers
    specsYes.addEventListener('change', () => {
        if (specsYes.checked) {
            needsGlassesCapture = true;
            currentSpecsMode = 'with';
            specsStatus.textContent = 'With glasses (will later need without glasses)';
        
            // Update title and show both preview groups
            document.getElementById('with-glasses-title').textContent = 'With Glasses';
            document.getElementById('preview-container').classList.add('capturing-both');
        }
    });
    
    specsNo.addEventListener('change', () => {
        if (specsNo.checked) {
            needsGlassesCapture = false;
            currentSpecsMode = 'without';
            specsStatus.textContent = 'Without glasses';
        
            // Update title and show only one preview group
            document.getElementById('with-glasses-title').textContent = 'Photos';
            document.getElementById('preview-container').classList.remove('capturing-both');
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Only process if video feed is active and not typing in input fields
        if (!video.srcObject || 
            document.activeElement.tagName === 'INPUT' || 
            document.activeElement.tagName === 'TEXTAREA') {
            return;
        }
        
        if (e.code === 'Space') {
            // Space = capture current angle
            e.preventDefault();
            
            // Visual feedback for spacebar press
            const spacebarHint = document.querySelector('.spacebar-hint');
            spacebarHint.style.backgroundColor = 'rgba(46, 204, 113, 0.8)';
            spacebarHint.textContent = 'Capturing...';
            
            // Only capture if a face is detected with good quality
            if (isFaceDetected) {
                captureCurrentAngle();
                // Reset spacebar hint after a short delay
                setTimeout(() => {
                    spacebarHint.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                    spacebarHint.textContent = 'Press SPACE to capture';
                }, 1000);
            } else {
                captureMessage.textContent = 'No face detected. Please position your face in the oval guide.';
                captureMessage.className = 'capture-message error';
                // Reset spacebar hint after a short delay
                setTimeout(() => {
                    spacebarHint.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                    spacebarHint.textContent = 'Press SPACE to capture';
                }, 1000);
            }
        } else if (e.code === 'F1') {
            // F1-F5 = capture specific angle
            e.preventDefault();
            captureSpecificAngle(0); // Front
        } else if (e.code === 'F2') {
            e.preventDefault();
            captureSpecificAngle(1); // Left
        } else if (e.code === 'F3') {
            e.preventDefault();
            captureSpecificAngle(2); // Right
        } else if (e.code === 'F4') {
            e.preventDefault();
            captureSpecificAngle(3); // Up
        } else if (e.code === 'F5') {
            e.preventDefault();
            captureSpecificAngle(4); // Down
        }
    });
    
    // Validate form before submission
    document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
        const employeeId = document.getElementById('employee_id').value.trim();
        const name = document.getElementById('name').value.trim();
        
        if (!employeeId || !name) {
            e.preventDefault();
            alert('Please fill in all required fields');
            return;
        }
        
        // Check if all angles have been captured
        if (capturedAngles.length < angles.length) {
            e.preventDefault();
            alert('Please capture all face angles before submitting');
            return;
        }
        
        // If employee wears glasses, check if we have both sets
        if (needsGlassesCapture && 
            (withGlassesCaptured.length < angles.length || 
             withoutGlassesCaptured.length < angles.length)) {
            e.preventDefault();
            alert('Please capture all angles both with and without glasses');
            return;
        }
    });
    
    // Function to detect faces using the backend API
    async function detectFace() {
        if (!video.videoWidth) return; // Skip if video not loaded
        
        const now = Date.now();
        if (now - lastFaceDetectionTime < FACE_DETECTION_INTERVAL) return; // Throttle detection
        lastFaceDetectionTime = now;
        
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert to base64 for sending to the server
        const imageData = canvas.toDataURL('image/jpeg', 0.7);
        
        try {
            // Perform face detection using fetch API
            const response = await fetch('/api/detect_face', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    image: imageData,
                    min_confidence: 0.5 // Use YOLO's high-accuracy mode
                }),
            });
            
            if (!response.ok) {
                throw new Error('Face detection failed');
            }
            
            const result = await response.json();
            
            if (result.faces && result.faces.length > 0) {
                // Find the largest face (most likely the main subject)
                const faces = result.faces;
                let mainFace = faces[0];
                
                // If multiple faces detected, find the largest one
                if (faces.length > 1) {
                    mainFace = faces.reduce((largest, face) => {
                        const currentArea = face.bbox[2] * face.bbox[3];
                        const largestArea = largest.bbox[2] * largest.bbox[3];
                        return currentArea > largestArea ? face : largest;
                    }, faces[0]);
                }
                
                const confidence = mainFace.confidence;
                
                // Show face detection status
                faceDetectionText.textContent = 'Face Detected';
                faceDetectionText.style.backgroundColor = 'rgba(46, 204, 113, 0.7)';
                faceDetectionText.style.display = 'block';
                spacebarHint.textContent = 'Press SPACE to capture';
                isFaceDetected = true;
            } else {
                // No face detected
                faceDetectionText.textContent = 'No Face Detected';
                faceDetectionText.style.backgroundColor = 'rgba(231, 76, 60, 0.7)';
                faceDetectionText.style.display = 'block';
                spacebarHint.textContent = 'Press SPACE to capture';
                isFaceDetected = false;
            }
        } catch (error) {
            console.error('Face detection error:', error);
            faceDetectionText.textContent = 'Detection error - Please try again';
            faceDetectionText.style.backgroundColor = 'rgba(231, 76, 60, 0.7)';
            faceDetectionText.style.display = 'block';
            
            isFaceDetected = false;
        }
    }
    
    // Start face detection when video starts
    video.addEventListener('play', () => {
        // Run face detection more frequently
        faceDetectionTimer = setInterval(detectFace, FACE_DETECTION_INTERVAL);
    });
    
    // Clean up when page unloads
    window.addEventListener('beforeunload', () => {
        if (faceDetectionTimer) {
            clearInterval(faceDetectionTimer);
        }
    });
</script>
{% endblock %}